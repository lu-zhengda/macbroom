# macbroom v0.3 Design

**Goal:** Expand scanner coverage, add visual polish, improve scanning UX with worker pool progress, and replace SpaceLens tree view with a treemap visualization.

**Four feature areas:**
1. New scanners (Python, Rust, Go, JetBrains)
2. Worker pool with per-scanner progress
3. SpaceLens treemap visualization
4. TUI polish (theme, progress bars, animations, layout)

---

## 1. New Scanners

Four new scanners implementing the existing `Scanner` interface.

| Scanner | Category | Targets |
|---------|----------|---------|
| PythonScanner | "Python" | pip cache (`~/Library/Caches/pip`), conda pkgs (`~/miniconda3/pkgs`, `~/anaconda3/pkgs`), stale virtualenvs (`.venv`/`venv` older than threshold) |
| RustScanner | "Rust" | `~/.cargo/registry/cache`, `~/.cargo/registry/src`, `target/` dirs in project trees |
| GoScanner | "Go" | `~/go/pkg/mod/cache`, Go build cache (`go env GOCACHE`) |
| JetBrainsScanner | "JetBrains" | `~/Library/Caches/JetBrains/*`, `~/Library/Logs/JetBrains/*`, old IDE version dirs |

Each scanner:
- Constructor with dependency injection (lookPath/runCmd for testability)
- Config toggle in `ScannersConfig`
- Tests with mocked filesystem

---

## 2. Worker Pool + Per-Scanner Progress

### Engine Changes

Add `ScanGroupedWithProgress` method:
- Semaphore-based worker pool (channel of size N, default 4)
- Progress callback per scanner: `Started`, `Done(targets, err)`
- No breaking changes to existing methods

### TUI Changes

New `viewScanning` state between menu and dashboard:

```
  Scanning...
  ✓ System Junk         42 items   12.3 MB
  ✓ Browser Cache       18 items    4.1 MB
  ⠋ Docker              scanning...
  ⠋ Node.js             scanning...
  ○ Python              waiting...
  ○ Rust                waiting...
```

Each scanner shows: waiting → scanning (spinner) → done (checkmark + count).

---

## 3. SpaceLens Treemap

Replace the TUI tree-list with a block-based treemap visualization.

### Algorithm
- Squarified treemap layout (produces readable rectangles)
- Terminal-aware: fills available width/height

### Rendering
- lipgloss-styled rectangles with directory name + size
- Color-coded by file type/category (blue=code, green=media, red=caches, gray=misc)

### Navigation
- Arrow keys to highlight blocks
- Enter to drill into directory (re-renders treemap for subtree)
- h/backspace to go up one level
- d to delete highlighted item (with confirmation)

### Scope
- CLI mode (`macbroom spacelens`) keeps the existing text tree output
- Treemap is the TUI visualization (menu or `spacelens -i`)
- Data layer unchanged — `SpaceLens.Analyze()` still builds the node tree

---

## 4. TUI Polish

### Color Theme (`internal/tui/theme.go`)
- Centralized palette: Primary, Secondary, Success, Warning, Danger
- Category-specific colors (each scanner gets its own)
- Replace all scattered inline `lipgloss.NewStyle()` calls

### Progress Bars
- Duplicate scan: file count progress
- SpaceLens: directory count progress
- Cleaning: items deleted / total
- Scanning: per-scanner status (from section 2)

### Animations
- Per-scanner spinners during scan
- Counter animations for size totals (tick up over ~500ms)
- Fade-in for results (partial → full opacity)

### Layout
- Bordered panels (lipgloss borders)
- Header bars with title + breadcrumb
- Footer bar with context-sensitive keybind hints
- Fixed-width columns in dashboard tables
- Consistent padding/margins between sections
